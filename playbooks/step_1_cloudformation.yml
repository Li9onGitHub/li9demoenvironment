---
- hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - ../config.yml
  tasks:
    - name: create key pair {{KeyName}}
      ec2_key:
        name: "{{KeyName}}"
        ec2_region: us-east-1
        aws_access_key: "{{aws_access_key}}"
        aws_secret_key: "{{aws_secret_key}}"
      register: ec2_key

    - name: save private key
      copy:
        content: "{{ ec2_key.key.private_key }}"
        dest: "~/{{KeyName}}.pem"
        mode: 0600
      when: ec2_key|changed

    - name: launch ansible cloudformation {{StackName}}
      cloudformation:
        stack_name: "{{StackName}}"
        state: "present"
        region: "us-east-1"
        disable_rollback: true
        template: "../cloudformation/openshift.json"
        aws_access_key: "{{aws_access_key}}"
        aws_secret_key: "{{aws_secret_key}}"
        template_parameters:
          KeyName: "{{KeyName}}"
          domaintag: "{{domaintag}}"
        tags:
          Stack: "{{StackName}}"
      register: cloudformation_results

    - name: show variable
      debug: var=cloudformation_results

#    - name: create ansible inventory file
#      template: src=../templates/ansible.hosts.j2 dest=~/inventory force=yes

    - name: add_host for node01
      add_host: 
        ansible_host={{cloudformation_results.stack_outputs.Node01}}
        groups=node01,nodes,openshift
        ansible_user=ec2-user
        ansible_ssh_private_key_file=~/{{KeyName}}.pem
        name=node01.{{localdomain}}
      changed_when: false

    - name: add_host for node02
      add_host:
        ansible_host={{cloudformation_results.stack_outputs.Node02}}
        groups=node02,nodes,openshift
        ansible_user=ec2-user
        ansible_ssh_private_key_file=~/{{KeyName}}.pem
        name=node02.{{localdomain}}
      changed_when: false

    - name: add_host for master node
      add_host:
        ansible_host={{cloudformation_results.stack_outputs.Master}}
        groups=master,openshift
        ansible_user=ec2-user
        ansible_ssh_private_key_file=~/{{KeyName}}.pem
        name=master01.{{localdomain}}
      changed_when: false

    - name: send an email that cloudformation is done
      mail:
        subject: "OpenShift is almost ready"
        to: "{{email}}"
        from: Li9 Demo <do-not-reply@demo.li9.com>
        body: |
          The first step of OpenShift configuration is commpleted - AWS Instances were deployed
          Please be aware that system is still configuring your OpenShift Enterprise and it will take some time.
          Once it's ready you will receive a new email
          The following information is important to connect to the service:
          *) Master node: master01.{{publicdomain}}
          *) Nodes: node01.{{publicdomain}} and node02.{{publicdomain}}
          *) All servers are running under Red Hat Enterprise Linux 7.x
          *) All hosts are accessible via ssh
          *) SSH username: ec2-user
          *) SSH access type: only using a private key 
          *) SSH private key is shown below:
          "{{ ec2_key.key.private_key }}"
          Thank you
          //Li9 team
      when: email is defined

